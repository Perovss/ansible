version: "2.4"

services:

  mattermost:
    container_name: mattermost
    image: docker.tourmachine.tech/infra/mattermost:${MATTERMOST_IMAGE_TAG}
    restart: ${RESTART_POLICY}
    security_opt:
    - no-new-privileges:true
    pids_limit: 200
    read_only: ${MATTERMOST_CONTAINER_READONLY}
    env_file:
    - .env
    tmpfs:
    - /tmp
    volumes:
    - ${MATTERMOST_CONFIG_PATH}:/mattermost/config:rw
    - ${MATTERMOST_DATA_PATH}:/mattermost/data:rw
    - ${MATTERMOST_LOGS_PATH}:/mattermost/logs:rw
    - ${MATTERMOST_PLUGINS_PATH}:/mattermost/plugins:rw
    - ${MATTERMOST_CLIENT_PLUGINS_PATH}:/mattermost/client/plugins:rw
    - ${MATTERMOST_BLEVE_INDEXES_PATH}:/mattermost/bleve-indexes:rw
    environment:
    # timezone inside container
    - TZ
    # necessary Mattermost options/variables (see env.example)
    - MM_SQLSETTINGS_DRIVERNAME
    # necessary for bleve
    - MM_BLEVESETTINGS_INDEXDIR

  nginx:
    depends_on:
    - mattermost
    container_name: nginx_mattermost
    image: nginx:${NGINX_IMAGE_TAG}
    restart: ${RESTART_POLICY}
    security_opt:
    - no-new-privileges:true
    pids_limit: 100
    read_only: true
    env_file:
    - .env
    tmpfs:
    - /var/run
    - /var/cache
    - /var/log/nginx
    volumes:
    - ${NGINX_CONFIG_PATH}:/etc/nginx/conf.d:ro
    - ${NGINX_DHPARAMS_FILE}:/dhparams4096.pem
    - ${CERT_PATH}:/cert.pem:ro
    - ${KEY_PATH}:/key.pem:ro
    - shared-webroot:/usr/share/nginx/html
    environment:
    # timezone inside container
    - TZ

    ports:
    - ${HTTPS_PORT}:443
    - ${HTTP_PORT}:80

# Shared volume for Let's Encrypt certificate renewal with a webroot
volumes:
  shared-webroot:
    name: shared-webroot

# This network name is being used for Let's Encrypt certificate renewal
networks:
  default:
    name: mattermost
